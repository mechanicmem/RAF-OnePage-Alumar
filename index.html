<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relatório de Análise de Falha (RAF)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            -webkit-print-color-adjust: exact;
        }

        /* Configuração A4 Paisagem */
        .a4-landscape {
            width: 297mm;
            min-height: 210mm;
            margin: 20px auto;
            background: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            padding: 10mm; 
            box-sizing: border-box;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        /* Notificação Toast Customizada */
        #toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .toast {
            color: white;
            padding: 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            animation: slideIn 0.3s ease-out forwards;
            max-width: 300px;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .toast-success { background-color: #22c55e; } /* Verde */
        .toast-error { background-color: #ef4444; }   /* Vermelho */
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }

        /* Modal de Imagem (Lightbox) */
        #image-modal {
            display: none;
            position: fixed;
            z-index: 9999;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        #image-modal img {
            max-width: 90%;
            max-height: 85vh;
            object-fit: contain;
            border: 2px solid white;
            border-radius: 4px;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }
        #image-modal .close-btn {
            position: absolute;
            top: 20px;
            right: 30px;
            color: white;
            font-size: 40px;
            cursor: pointer;
            transition: color 0.3s;
        }
        #image-modal .close-btn:hover {
            color: #ef4444;
        }

        /* Estilos de Impressão */
        @media print {
            @page {
                size: landscape;
                margin: 0;
            }
            body {
                background: white;
                margin: 0;
                transform-origin: top left;
                width: 100%;
            }
            .a4-landscape {
                margin: 0;
                box-shadow: none;
                width: 100%;
                height: 100vh;
                padding: 5mm;
                border: none;
            }
            .no-print {
                display: none !important;
            }
            input, textarea, select {
                border: none !important;
                background: transparent !important;
                resize: none !important;
                padding: 0;
                appearance: none;
            }
            .analysis-option.hidden {
                display: none !important;
            }
            .layout-hidden {
                display: none !important;
            }
            ::-webkit-scrollbar { display: none; }
            * { overflow: visible !important; }
            .layout-selector-fade {
                display: none !important;
            }
        }

        /* Classes utilitárias */
        .section-header {
            background-color: #1e3a8a;
            color: white;
            padding: 0.3rem 0.5rem;
            font-weight: 700;
            text-transform: uppercase;
            font-size: 0.75rem;
            margin-bottom: 0.3rem;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: background-color 0.2s;
        }
        
        .input-bare {
            width: 100%;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            padding: 2px 6px;
            font-size: 0.85rem;
            transition: border-color 0.2s;
        }
        .input-bare:focus {
            outline: none;
            border-color: #2563eb;
            background-color: #eff6ff;
        }

        /* Area de Upload de Imagem */
        .image-upload-box {
            border: 2px dashed #d1d5db;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            min-height: 40px; 
            cursor: pointer;
            overflow: hidden;
            position: relative;
            background-color: #f9fafb;
            transition: all 0.2s ease;
        }
        .image-upload-box:hover {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }
        .image-upload-box.drag-over {
            border-color: #2563eb;
            background-color: #dbeafe;
            transform: scale(1.02);
        }
        .uploaded-img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            cursor: zoom-in;
        }
        
        /* Botões de ação flutuantes na imagem */
        .img-actions {
            position: absolute;
            top: 4px;
            right: 4px;
            display: flex;
            gap: 4px;
            z-index: 10;
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
        }
        .image-upload-box:hover .img-actions,
        .logo-upload-box:hover .img-actions {
            opacity: 1;
        }

        .img-action-btn {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid #d1d5db;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            transition: all 0.2s;
            color: #4b5563;
        }
        .img-action-btn:hover {
            background: #2563eb;
            color: white;
            border-color: #2563eb;
        }
        .img-action-btn.delete:hover {
            background: #ef4444;
            color: white;
            border-color: #ef4444;
        }
        
        /* Logo Upload Específico */
        .logo-upload-box {
            width: 3.5rem;
            height: 3.5rem;
            min-width: 2rem;
            min-height: 2rem;
            max-width: 200px;
            max-height: 200px;
            border: 1px dashed #d1d5db;
            background-color: #f3f4f6;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            cursor: pointer;
            overflow: hidden;
            position: relative;
            resize: both;
        }
        .logo-upload-box:hover {
            border-color: #3b82f6;
        }
        
        label {
            font-size: 0.7rem !important;
            margin-bottom: 0.1rem !important;
        }

        .analysis-select {
            background-color: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.4);
            font-size: 0.7rem;
            border-radius: 4px;
            padding: 1px 4px;
            cursor: pointer;
        }
        .analysis-select option {
            background-color: #1e3a8a;
            color: white;
        }

        /* Seletor de Layout */
        .layout-selector-fade {
            opacity: 0.1;
            background-color: transparent;
            border: 1px solid transparent;
            color: white;
            font-size: 0.65rem;
            border-radius: 4px;
            padding: 1px 4px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .section-header:hover .layout-selector-fade,
        .layout-selector-fade:focus {
            opacity: 1;
            background-color: rgba(255,255,255,0.2);
            border-color: rgba(255,255,255,0.4);
        }
        .layout-selector-fade option {
            background-color: #1e3a8a;
            color: white;
        }

        /* Classes Customizadas */
        .resizable-y {
            resize: vertical;
            overflow: auto;
            min-height: 2rem;
            max-height: 90%;
        }
        .resizable-x {
            resize: horizontal;
            overflow: auto;
            min-width: 100px;
            max-width: 80%;
        }
        
        /* Drag Overlay Global */
        #drag-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(37, 99, 235, 0.2);
            border: 4px dashed #2563eb;
            z-index: 10000;
            justify-content: center;
            align-items: center;
            font-size: 2rem;
            color: #1e3a8a;
            font-weight: bold;
            pointer-events: none; /* Permite que o evento drop chegue no body */
        }
    </style>
</head>
<body class="pb-10 overflow-x-auto relative">

    <!-- Overlay de Drag & Drop Global -->
    <div id="drag-overlay">
        <span>Solte o relatório para carregar</span>
    </div>

    <!-- Container para notificações Toast -->
    <div id="toast-container" class="no-print"></div>

    <!-- Modal Lightbox -->
    <div id="image-modal" class="no-print" onclick="closeImageModal()">
        <span class="close-btn">&times;</span>
        <img id="modal-img" src="" alt="Visualização Ampliada" onclick="event.stopPropagation()">
        <p class="text-white mt-2 text-sm">Clique fora da imagem para fechar</p>
    </div>

    <!-- Créditos Discretos -->
    <div class="fixed bottom-1 left-2 text-[10px] text-gray-400 opacity-50 hover:opacity-100 transition-opacity no-print select-none z-50 font-light">
        Made by: Henrique Melo
    </div>

    <!-- Botões Flutuantes de Ação -->
    <div class="fixed bottom-5 right-5 flex flex-col gap-2 no-print z-50">
        <!-- Input invisível para carregar arquivo -->
        <input type="file" id="loadFile" accept=".json, .html" class="hidden" onchange="loadReportData(this)">
        
        <button onclick="clearReport()" class="bg-red-600 hover:bg-red-700 text-white w-12 h-12 rounded-full shadow-lg transition-all flex items-center justify-center" title="Limpar Formulário">
            <i class="fas fa-trash-alt"></i>
        </button>

        <button onclick="document.getElementById('loadFile').click()" class="bg-yellow-500 hover:bg-yellow-600 text-white w-12 h-12 rounded-full shadow-lg transition-all flex items-center justify-center" title="Carregar Relatório Salvo">
            <i class="fas fa-folder-open"></i>
        </button>
        
        <button onclick="saveReportData()" class="bg-green-600 hover:bg-green-700 text-white w-12 h-12 rounded-full shadow-lg transition-all flex items-center justify-center" title="Salvar HTML Autônomo">
            <i class="fas fa-save"></i>
        </button>

        <button onclick="window.print()" class="bg-blue-600 hover:bg-blue-700 text-white w-12 h-12 rounded-full shadow-lg transition-all flex items-center justify-center" title="Imprimir / Gerar PDF">
            <i class="fas fa-print"></i>
        </button>
    </div>

    <div class="a4-landscape" id="report">
        
        <!-- CABEÇALHO -->
        <header class="flex justify-between items-center border-b-2 border-blue-900 pb-2 mb-2">
            <div class="flex items-center gap-4">
                <!-- Logo -->
                <div class="logo-upload-box" id="logoBox" onclick="triggerUpload('logoInput')">
                    <input type="file" id="logoInput" class="hidden" accept="image/*" onchange="previewImage(this, 'logoImg', 'logoPlaceholder')">
                    <div id="logoPlaceholder" class="text-gray-400 font-bold text-[10px] text-center leading-tight select-none">
                        LOGO<br>EMPRESA
                    </div>
                    <img id="logoImg" class="uploaded-img hidden" src="" alt="Logo" onclick="openImageModal(this.src); event.stopPropagation()">
                    
                    <div id="actions-logoImg" class="img-actions hidden no-print">
                        <button class="img-action-btn" onclick="triggerUpload('logoInput'); event.stopPropagation()" title="Alterar Logo">
                            <i class="fas fa-pen text-[10px]"></i>
                        </button>
                        <button class="img-action-btn delete" onclick="removeImage('logoImg', 'logoPlaceholder', 'logoInput'); event.stopPropagation()" title="Remover Logo">
                            <i class="fas fa-trash text-[10px]"></i>
                        </button>
                    </div>
                </div>
                
                <div>
                    <h1 class="text-xl font-bold text-gray-800 uppercase">Relatório de Análise de Falha (RAF)</h1>
                    <p class="text-xs text-gray-600">Engenharia de Manutenção & Confiabilidade</p>
                </div>
            </div>
            <div class="flex gap-4">
                <div class="text-right">
                    <span class="block text-[10px] font-bold text-gray-500 uppercase">ID Relatório</span>
                    <input type="text" id="reportIdInput" class="input-bare w-32 text-right font-mono font-bold text-sm static-input" value="RFA-2026-001">
                </div>
                <div class="text-right">
                    <span class="block text-[10px] font-bold text-gray-500 uppercase">Criticidade</span>
                    <select id="criticalitySelect" onchange="updateCriticalityColor(this)" class="input-bare w-28 text-right font-bold text-red-600 text-sm static-input">
                        <option value="alta" class="text-red-600">Alta</option>
                        <option value="media" class="text-yellow-600">Média</option>
                        <option value="baixa" class="text-green-600">Baixa</option>
                    </select>
                </div>
            </div>
        </header>

        <div class="grid grid-cols-12 gap-4 flex-grow mb-2">
            
            <!-- COLUNA ESQUERDA -->
            <div class="col-span-5 flex flex-col gap-2">
                
                <!-- 1. DADOS GERAIS -->
                <div>
                    <div class="section-header">
                        <span><i class="fas fa-info-circle mr-2"></i> 1. Informações Gerais</span>
                    </div>
                    <div class="grid grid-cols-2 gap-2 mb-1">
                        <div>
                            <label class="block text-gray-600 font-bold">Data da Falha</label>
                            <input type="text" id="inputDate" class="input-bare static-input" placeholder="dd/mm/yyyy" maxlength="10" oninput="dateMask(this)">
                        </div>
                        <div>
                            <label class="block text-gray-600 font-bold">Tempo Parada (h)</label>
                            <input type="number" class="input-bare static-input" placeholder="0.0">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-2 mb-1">
                        <div>
                            <label class="block text-gray-600 font-bold">Área / Setor</label>
                            <input type="text" class="input-bare static-input" placeholder="Área...">
                        </div>
                        <div>
                            <label class="block text-gray-600 font-bold">TAG / Ativo</label>
                            <input type="text" id="inputTag" class="input-bare static-input" placeholder="TAG...">
                        </div>
                    </div>
                    <div>
                         <label class="block text-gray-600 font-bold">Modo de Falha</label>
                         <input type="text" id="inputFailureMode" class="input-bare static-input" placeholder="Ex: Desgaste, Fadiga, Sobrecarga...">
                    </div>
                </div>

                <!-- 2. DESCRIÇÃO -->
                <div>
                    <div class="section-header group">
                        <span><i class="fas fa-align-left mr-2"></i> 2. Descrição (Operação)</span>
                        <select id="layoutSec2" onchange="updateLayout('sec2', this.value)" class="layout-selector-fade" title="Alterar Layout">
                            <option value="default">Layout Padrão</option>
                            <option value="side">Layout Lado a Lado</option>
                            <option value="text">Layout Só Texto</option>
                        </select>
                    </div>
                    
                    <div id="sec2-container" class="flex flex-col gap-2 h-44 border border-transparent hover:border-gray-200 transition-colors rounded p-0.5">
                        <textarea id="sec2-text" class="input-bare w-full h-16 text-sm resize-none static-input resizable-y" placeholder="Descrição do operador: O que aconteceu? Sintomas?"></textarea>
                        
                        <div id="sec2-imgs" class="grid grid-cols-2 gap-2 flex-grow overflow-hidden min-h-0">
                            <!-- Imagem 1 -->
                            <div class="image-upload-box" id="box-imgDesc1" onclick="triggerUpload('imgDesc1')">
                                <input type="file" id="imgDesc1" class="hidden" accept="image/*" onchange="previewImage(this, 'view-imgDesc1', 'ph-imgDesc1')">
                                <div id="ph-imgDesc1" class="text-center text-gray-400 placeholder-content">
                                    <i class="fas fa-camera text-lg mb-1"></i>
                                    <p class="text-[9px]">Evidência Operação 1</p>
                                </div>
                                <img id="view-imgDesc1" class="uploaded-img hidden" src="" alt="Evidencia" onclick="openImageModal(this.src); event.stopPropagation()">
                                <div id="actions-view-imgDesc1" class="img-actions hidden no-print">
                                    <button class="img-action-btn" onclick="triggerUpload('imgDesc1'); event.stopPropagation()"><i class="fas fa-pen text-[10px]"></i></button>
                                    <button class="img-action-btn delete" onclick="removeImage('view-imgDesc1', 'ph-imgDesc1', 'imgDesc1'); event.stopPropagation()"><i class="fas fa-trash text-[10px]"></i></button>
                                </div>
                            </div>
                            <!-- Imagem 2 -->
                            <div class="image-upload-box" id="box-imgDesc2" onclick="triggerUpload('imgDesc2')">
                                <input type="file" id="imgDesc2" class="hidden" accept="image/*" onchange="previewImage(this, 'view-imgDesc2', 'ph-imgDesc2')">
                                <div id="ph-imgDesc2" class="text-center text-gray-400 placeholder-content">
                                    <i class="fas fa-camera text-lg mb-1"></i>
                                    <p class="text-[9px]">Evidência Operação 2</p>
                                </div>
                                <img id="view-imgDesc2" class="uploaded-img hidden" src="" alt="Evidencia" onclick="openImageModal(this.src); event.stopPropagation()">
                                <div id="actions-view-imgDesc2" class="img-actions hidden no-print">
                                    <button class="img-action-btn" onclick="triggerUpload('imgDesc2'); event.stopPropagation()"><i class="fas fa-pen text-[10px]"></i></button>
                                    <button class="img-action-btn delete" onclick="removeImage('view-imgDesc2', 'ph-imgDesc2', 'imgDesc2'); event.stopPropagation()"><i class="fas fa-trash text-[10px]"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 3. EVIDÊNCIAS ENGENHARIA -->
                <div class="flex-grow">
                    <div class="section-header group">
                        <span><i class="fas fa-search mr-2"></i> 3. Evidências Técnicas (Engenharia)</span>
                        <select id="layoutSec3" onchange="updateLayout('sec3', this.value)" class="layout-selector-fade" title="Alterar Layout">
                            <option value="default">Layout Padrão</option>
                            <option value="side">Layout Lado a Lado</option>
                            <option value="text">Layout Só Texto</option>
                        </select>
                    </div>
                    
                    <div id="sec3-container" class="flex flex-col gap-2 h-44 border border-transparent hover:border-gray-200 transition-colors rounded p-0.5">
                        <textarea id="sec3-text" class="input-bare w-full h-16 text-sm resize-none static-input resizable-y" placeholder="Análise técnica de campo: O que foi encontrado desmontado? Condição dos componentes?"></textarea>
                        
                        <div id="sec3-imgs" class="grid grid-cols-2 gap-2 flex-grow overflow-hidden min-h-0">
                            <!-- Imagem Eng 1 -->
                            <div class="image-upload-box" id="box-imgEng1" onclick="triggerUpload('imgEng1')">
                                <input type="file" id="imgEng1" class="hidden" accept="image/*" onchange="previewImage(this, 'view-imgEng1', 'ph-imgEng1')">
                                <div id="ph-imgEng1" class="text-center text-gray-400 placeholder-content">
                                    <i class="fas fa-microscope text-lg mb-1"></i>
                                    <p class="text-[9px]">Evidência Técnica 1</p>
                                </div>
                                <img id="view-imgEng1" class="uploaded-img hidden" src="" alt="Evidencia" onclick="openImageModal(this.src); event.stopPropagation()">
                                <div id="actions-view-imgEng1" class="img-actions hidden no-print">
                                    <button class="img-action-btn" onclick="triggerUpload('imgEng1'); event.stopPropagation()"><i class="fas fa-pen text-[10px]"></i></button>
                                    <button class="img-action-btn delete" onclick="removeImage('view-imgEng1', 'ph-imgEng1', 'imgEng1'); event.stopPropagation()"><i class="fas fa-trash text-[10px]"></i></button>
                                </div>
                            </div>
                            <!-- Imagem Eng 2 -->
                            <div class="image-upload-box" id="box-imgEng2" onclick="triggerUpload('imgEng2')">
                                <input type="file" id="imgEng2" class="hidden" accept="image/*" onchange="previewImage(this, 'view-imgEng2', 'ph-imgEng2')">
                                <div id="ph-imgEng2" class="text-center text-gray-400 placeholder-content">
                                    <i class="fas fa-microscope text-lg mb-1"></i>
                                    <p class="text-[9px]">Evidência Técnica 2</p>
                                </div>
                                <img id="view-imgEng2" class="uploaded-img hidden" src="" alt="Evidencia" onclick="openImageModal(this.src); event.stopPropagation()">
                                <div id="actions-view-imgEng2" class="img-actions hidden no-print">
                                    <button class="img-action-btn" onclick="triggerUpload('imgEng2'); event.stopPropagation()"><i class="fas fa-pen text-[10px]"></i></button>
                                    <button class="img-action-btn delete" onclick="removeImage('view-imgEng2', 'ph-imgEng2', 'imgEng2'); event.stopPropagation()"><i class="fas fa-trash text-[10px]"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <!-- COLUNA DIREITA -->
            <div class="col-span-7 flex flex-col gap-2">

                <!-- 4. ANÁLISE DE CAUSA -->
                <div class="h-60 flex flex-col">
                    <div class="section-header">
                        <span><i class="fas fa-project-diagram mr-2"></i> 4. Análise de Causa Raiz</span>
                        <div class="flex items-center gap-2">
                            <span class="text-[9px] font-normal opacity-80 uppercase">Método:</span>
                            <select id="analysisSelector" onchange="toggleAnalysis(this.value)" class="analysis-select">
                                <option value="ishikawa">Diagrama de Ishikawa / Árvore</option>
                                <option value="5whys">5 Porquês</option>
                            </select>
                        </div>
                    </div>

                    <!-- Ishikawa -->
                    <div id="view-ishikawa" class="analysis-option flex-grow border border-gray-300 rounded bg-white p-1 overflow-hidden relative">
                        <div class="image-upload-box bg-white h-full w-full border-none" id="box-diagramImg" onclick="triggerUpload('diagramImg')">
                            <input type="file" id="diagramImg" class="hidden" accept="image/*" onchange="previewImage(this, 'view-diagramImg', 'ph-diagramImg')">
                            <div id="ph-diagramImg" class="text-center text-gray-400 placeholder-content">
                                <i class="fas fa-chart-network text-4xl mb-2 text-gray-300"></i>
                                <p class="text-xs">Arraste ou Clique para imagem do Diagrama</p>
                            </div>
                            <img id="view-diagramImg" class="uploaded-img hidden" src="" alt="Diagrama" onclick="openImageModal(this.src); event.stopPropagation()">
                            <div id="actions-view-diagramImg" class="img-actions hidden no-print">
                                <button class="img-action-btn" onclick="triggerUpload('diagramImg'); event.stopPropagation()"><i class="fas fa-pen text-[10px]"></i></button>
                                <button class="img-action-btn delete" onclick="removeImage('view-diagramImg', 'ph-diagramImg', 'diagramImg'); event.stopPropagation()"><i class="fas fa-trash text-[10px]"></i></button>
                            </div>
                        </div>
                    </div>

                    <!-- 5 Porquês -->
                    <div id="view-5whys" class="analysis-option flex-grow border border-gray-300 rounded bg-white p-4 hidden flex flex-col justify-center space-y-2">
                        <div class="flex items-center gap-2">
                            <span class="text-xs font-bold text-blue-800 w-20 whitespace-nowrap">1. Por que?</span>
                            <input type="text" class="input-bare py-1 text-sm flex-1 static-input" placeholder="Responda aqui...">
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-xs font-bold text-blue-800 w-20 whitespace-nowrap">2. Por que?</span>
                            <input type="text" class="input-bare py-1 text-sm flex-1 static-input" placeholder="Responda aqui...">
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-xs font-bold text-blue-800 w-20 whitespace-nowrap">3. Por que?</span>
                            <input type="text" class="input-bare py-1 text-sm flex-1 static-input" placeholder="Responda aqui...">
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-xs font-bold text-blue-800 w-20 whitespace-nowrap">4. Por que?</span>
                            <input type="text" class="input-bare py-1 text-sm flex-1 static-input" placeholder="Responda aqui...">
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-xs font-bold text-red-600 w-20 whitespace-nowrap">5. Causa Raiz</span>
                            <input type="text" class="input-bare py-1 text-sm font-bold bg-yellow-50 flex-1 static-input" placeholder="Causa Raiz Identificada">
                        </div>
                    </div>
                </div>

                <!-- 5. SOLUÇÃO TÉCNICA -->
                <div>
                    <div class="section-header">
                        <span><i class="fas fa-wrench mr-2"></i> 5. Solução Técnica Adotada</span>
                    </div>
                    <textarea id="solutionText" class="input-bare w-full h-16 text-sm resizable-y static-input" placeholder="Descrição técnica da resolução..."></textarea>
                </div>

                <!-- 6. PLANO DE AÇÃO -->
                <div class="flex-grow flex flex-col overflow-hidden">
                    <div class="section-header flex justify-between">
                        <span><i class="fas fa-clipboard-list mr-2"></i> 6. Plano de Ação (5W2H)</span>
                        <button onclick="addActionRow()" class="bg-blue-500 hover:bg-blue-600 text-white text-[10px] px-2 py-0.5 rounded no-print">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    <div class="border border-gray-300 flex-grow bg-white overflow-y-auto">
                        <table class="w-full text-xs text-left text-gray-600" id="actionTable">
                            <thead class="text-[10px] text-gray-700 uppercase bg-gray-100 border-b sticky top-0">
                                <tr>
                                    <th class="px-2 py-1 border-r w-1/2">O Que (Ação)</th>
                                    <th class="px-2 py-1 border-r">Quem</th>
                                    <th class="px-2 py-1 border-r w-24">Quando</th>
                                    <th class="px-2 py-1 text-center w-24">Status</th>
                                    <th class="w-6 no-print"></th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Linhas dinâmicas -->
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>
        </div>

        <!-- RODAPÉ -->
        <footer class="mt-auto pt-2 border-t-2 border-gray-300">
            <div class="mb-1 px-1">
                <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">Equipe Multidisciplinar / Participantes da Análise</label>
                <textarea id="participantsText" class="input-bare w-full h-10 text-xs resize-none static-input bg-gray-50 resizable-y" placeholder="Liste aqui os nomes dos participantes envolvidos na análise..."></textarea>
            </div>
        </footer>

    </div>

    <!-- DADOS EMBUTIDOS (Placeholder) -->
    <script id="raf-data-embedded" type="application/json"></script>

    <script>
        // --- FUNÇÃO TOAST ---
        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type === 'error' ? 'toast-error' : 'toast-success'}`;
            toast.innerHTML = `<i class="fas ${type === 'error' ? 'fa-exclamation-triangle' : 'fa-check-circle'}"></i> <span>${message}</span>`;
            container.appendChild(toast);
            setTimeout(() => {
                toast.style.animation = 'fadeOut 0.3s ease-out forwards';
                setTimeout(() => {
                    if (toast.parentNode) toast.parentNode.removeChild(toast);
                }, 300);
            }, 3000);
        }

        // --- INICIALIZAÇÃO E DRAG & DROP GLOBAL ---
        document.addEventListener('DOMContentLoaded', () => {
            // Inicializar Drag & Drop
            const dropZones = [
                { box: 'logoBox', input: 'logoInput' },
                { box: 'box-imgDesc1', input: 'imgDesc1' },
                { box: 'box-imgDesc2', input: 'imgDesc2' },
                { box: 'box-imgEng1', input: 'imgEng1' },
                { box: 'box-imgEng2', input: 'imgEng2' },
                { box: 'box-diagramImg', input: 'diagramImg' }
            ];
            dropZones.forEach(zone => setupDragAndDrop(zone.box, zone.input));

            // Tabela Inicial
            if(document.querySelector('#actionTable tbody').children.length === 0) {
                addActionRow(); addActionRow(); addActionRow();
            }

            // Cor Criticidade
            const critSelect = document.getElementById('criticalitySelect');
            if(critSelect) updateCriticalityColor(critSelect);

            // Título Dinâmico
            const idInput = document.getElementById('reportIdInput');
            if(idInput) {
                document.title = idInput.value || "Relatório de Análise de Falha (RAF)";
                idInput.addEventListener('input', (e) => {
                    document.title = e.target.value || "Relatório de Análise de Falha (RAF)";
                });
            }

            // *** CARREGAMENTO AUTOMÁTICO DE DADOS EMBUTIDOS ***
            const embeddedScript = document.getElementById('raf-data-embedded');
            if (embeddedScript && embeddedScript.textContent.trim()) {
                try {
                    const data = JSON.parse(embeddedScript.textContent);
                    applyLoadedData(data);
                } catch (e) {
                    console.error("Erro ao carregar dados embutidos", e);
                }
            }

            // *** DRAG & DROP GLOBAL PARA CARREGAR ARQUIVO ***
            const dragOverlay = document.getElementById('drag-overlay');
            
            document.addEventListener('dragover', (e) => {
                e.preventDefault();
                // Mostra overlay se não estiver sobre uma área de upload de imagem
                if (!e.target.closest('.image-upload-box') && !e.target.closest('.logo-upload-box')) {
                    dragOverlay.style.display = 'flex';
                }
            });

            document.addEventListener('dragleave', (e) => {
                // Esconde se sair da janela ou do overlay
                if (e.relatedTarget === null || e.target === dragOverlay) {
                    dragOverlay.style.display = 'none';
                }
            });

            document.addEventListener('drop', (e) => {
                e.preventDefault();
                dragOverlay.style.display = 'none';

                // Ignora se drop foi em uma área de upload de imagem específica
                if (e.target.closest('.image-upload-box') || e.target.closest('.logo-upload-box')) return;

                if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
                    handleFileLoadRequest(e.dataTransfer.files[0]);
                }
            });
        });

        function handleFileLoadRequest(file) {
            // Verifica se o formulário está "sujo" (tem dados preenchidos)
            if (isReportDirty()) {
                if (!confirm("O relatório atual contém dados. Carregar um novo arquivo irá sobrescrevê-los. Deseja continuar?")) {
                    return;
                }
            }
            
            // Simula o input de arquivo
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(file);
            const fileInput = document.getElementById('loadFile');
            fileInput.files = dataTransfer.files;
            
            // Chama a função de carregamento
            loadReportData(fileInput);
        }

        // Verifica se há dados significativos no relatório
        function isReportDirty() {
            // Verifica inputs de texto (ignorando o ID padrão e data vazia)
            const inputs = document.querySelectorAll('.static-input');
            for (let input of inputs) {
                if (input.id === 'reportIdInput' && input.value === 'RFA-2026-001') continue;
                if (input.value.trim() !== '') return true;
            }
            
            // Verifica imagens
            const images = document.querySelectorAll('.uploaded-img');
            for (let img of images) {
                if (!img.classList.contains('hidden') && img.src) return true;
            }
            
            return false;
        }

        // --- MANIPULAÇÃO DE DADOS ---
        function collectData() {
            const data = {
                staticInputs: [],
                images: {},
                tableRows: [],
                analysisType: document.getElementById('analysisSelector').value,
                layoutSec2: document.getElementById('layoutSec2').value,
                layoutSec3: document.getElementById('layoutSec3').value,
                criticality: document.getElementById('criticalitySelect').value,
                dimensions: {}
            };

            const inputs = document.querySelectorAll('.static-input');
            inputs.forEach((input) => data.staticInputs.push(input.value));

            const imgIds = ['logoImg', 'view-imgDesc1', 'view-imgDesc2', 'view-imgEng1', 'view-imgEng2', 'view-diagramImg'];
            imgIds.forEach(id => {
                const img = document.getElementById(id);
                if (!img.classList.contains('hidden') && img.src) {
                    data.images[id] = img.src;
                }
            });

            const rows = document.querySelectorAll('#actionTable tbody tr');
            rows.forEach(row => {
                const fields = row.querySelectorAll('input, select, textarea');
                if(fields.length >= 4) {
                    data.tableRows.push({
                        action: fields[0].value,
                        resp: fields[1].value,
                        date: fields[2].value,
                        status: fields[3].value
                    });
                }
            });

            const resizableIds = ['sec2-text', 'sec3-text', 'sec2-imgs', 'sec3-imgs', 'solutionText', 'participantsText', 'logoBox'];
            resizableIds.forEach(id => {
                const el = document.getElementById(id);
                if(el) data.dimensions[id] = { width: el.style.width, height: el.style.height };
            });

            return data;
        }

        // --- SALVAR (EXPORTAÇÃO AUTÔNOMA COM SAVE AS) ---
        async function saveReportData() {
            const data = collectData();
            
            // Dados para Nome do Arquivo
            const dateInput = document.getElementById('inputDate').value || '';
            const tagInput = document.getElementById('inputTag').value || 'TAG';
            const failureModeInput = document.getElementById('inputFailureMode').value || 'Modo_Falha';
            
            let dateFormatted = 'DATA';
            if(dateInput) {
                const parts = dateInput.split('/');
                if(parts.length === 3) dateFormatted = parts[2] + parts[1] + parts[0];
            }
            const fileName = `${dateFormatted}_${tagInput}_${failureModeInput}.html`;

            // Clonar o HTML atual
            let fullHTML = document.documentElement.outerHTML;

            // Injetar os dados no script de placeholder
            const dataString = JSON.stringify(data);
            const scriptRegex = /<script[^>]*id=["']raf-data-embedded["'][^>]*>[\s\S]*?<\/script>/i;
            const newScript = `<script id="raf-data-embedded" type="application/json">${dataString}<\/script>`;
            
            if (scriptRegex.test(fullHTML)) {
                fullHTML = fullHTML.replace(scriptRegex, newScript);
            } else {
                fullHTML = fullHTML.replace('</body>', `${newScript}</body>`);
            }

            const blob = new Blob([fullHTML], {type: "text/html"});

            // Tentar usar File System Access API para "Salvar Como"
            if (window.showSaveFilePicker) {
                try {
                    const handle = await window.showSaveFilePicker({
                        suggestedName: fileName,
                        types: [{
                            description: 'Arquivo HTML RAF',
                            accept: {'text/html': ['.html']},
                        }],
                    });
                    const writable = await handle.createWritable();
                    await writable.write(blob);
                    await writable.close();
                    showToast("Arquivo salvo com sucesso!", 'success');
                    return;
                } catch (err) {
                    if (err.name !== 'AbortError') {
                        console.error("Erro ao usar File Picker:", err);
                        // Fallback para download clássico abaixo
                    } else {
                        return; // Usuário cancelou
                    }
                }
            }

            // Fallback clássico
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            showToast("Arquivo salvo com sucesso!", 'success');
        }

        function loadReportData(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    let data;
                    const content = e.target.result;
                    
                    if (content.trim().startsWith('{')) {
                        data = JSON.parse(content); // JSON Antigo
                    } else {
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(content, "text/html");
                        const script = doc.getElementById('raf-data-embedded');
                        if (script && script.textContent.trim()) {
                            data = JSON.parse(script.textContent);
                        }
                    }

                    if(data) {
                        applyLoadedData(data);
                        showToast("Relatório carregado com sucesso!", 'success');
                    } else {
                        showToast("Dados não encontrados no arquivo.", 'error');
                    }
                } catch (err) {
                    showToast("Erro ao ler arquivo.", 'error');
                    console.error(err);
                }
                // Limpa o input para permitir carregar o mesmo arquivo novamente se necessário
                input.value = '';
            };
            reader.readAsText(file);
        }

        function applyLoadedData(data) {
            // Inputs
            const inputs = document.querySelectorAll('.static-input');
            if (data.staticInputs) {
                inputs.forEach((input, index) => {
                    if (data.staticInputs[index] !== undefined) input.value = data.staticInputs[index];
                });
            }
            
            const reportIdInput = document.getElementById('reportIdInput');
            if(reportIdInput) document.title = reportIdInput.value || "Relatório de Análise de Falha (RAF)";

            // Criticidade
            if (data.criticality) {
                const s = document.getElementById('criticalitySelect');
                s.value = data.criticality;
                updateCriticalityColor(s);
            }

            // Imagens
            for (const [imgId, src] of Object.entries(data.images || {})) {
                let phId = '';
                if(imgId === 'logoImg') phId = 'logoPlaceholder';
                else if(imgId.includes('view-')) phId = imgId.replace('view-', 'ph-');
                
                if(phId) displayImage(src, imgId, phId);
            }

            // Tabela
            const tbody = document.querySelector('#actionTable tbody');
            tbody.innerHTML = '';
            if (data.tableRows && data.tableRows.length > 0) {
                data.tableRows.forEach(rowData => addActionRow(rowData));
            } else {
                addActionRow(); addActionRow(); addActionRow();
            }

            // Layouts & Análise
            if (data.analysisType) {
                document.getElementById('analysisSelector').value = data.analysisType;
                toggleAnalysis(data.analysisType);
            }
            if (data.layoutSec2) {
                document.getElementById('layoutSec2').value = data.layoutSec2;
                updateLayout('sec2', data.layoutSec2);
            }
            if (data.layoutSec3) {
                document.getElementById('layoutSec3').value = data.layoutSec3;
                updateLayout('sec3', data.layoutSec3);
            }

            // Dimensões
            if (data.dimensions) {
                for (const [id, dims] of Object.entries(data.dimensions)) {
                    const el = document.getElementById(id);
                    if (el) {
                        if (dims.width) el.style.width = dims.width;
                        if (dims.height) el.style.height = dims.height;
                    }
                }
            }
        }

        // --- MODAL IMAGE ---
        function openImageModal(src) {
            document.getElementById('modal-img').src = src;
            document.getElementById('image-modal').style.display = 'flex';
        }
        function closeImageModal() {
            document.getElementById('image-modal').style.display = 'none';
        }

        // --- AUXILIARES (UI) ---
        function updateCriticalityColor(select) {
            select.classList.remove('text-red-600', 'text-yellow-600', 'text-green-600');
            if (select.value === 'alta') select.classList.add('text-red-600');
            else if (select.value === 'media') select.classList.add('text-yellow-600');
            else if (select.value === 'baixa') select.classList.add('text-green-600');
        }

        function updateStatusColor(select) {
            select.className = "bg-transparent text-[10px] font-bold text-center w-full focus:outline-none " + 
                (select.value === 'aberto' ? 'text-red-600' : 
                 select.value === 'andamento' ? 'text-yellow-600' : 'text-green-600');
        }

        function clearReport() {
            // Verifica se está sujo antes de perguntar
            if (isReportDirty()) {
                if (!confirm("Tem a certeza que deseja limpar todo o formulário? Todas as informações não salvas serão perdidas.")) {
                    return;
                }
            }
            
            // Reset Inputs
            document.querySelectorAll('.static-input').forEach(i => i.value = '');
            document.getElementById('reportIdInput').value = 'RFA-2026-001';
            
            // Reset Selects
            document.getElementById('criticalitySelect').value = 'alta';
            updateCriticalityColor(document.getElementById('criticalitySelect'));
            document.getElementById('analysisSelector').value = 'ishikawa';
            toggleAnalysis('ishikawa');
            
            // Reset Layouts
            ['sec2', 'sec3'].forEach(sec => {
                document.getElementById(`layout${sec.charAt(0).toUpperCase() + sec.slice(1)}`).value = 'default';
                updateLayout(sec, 'default');
            });

            // Reset Imagens
            const imgIds = ['logoImg', 'view-imgDesc1', 'view-imgDesc2', 'view-imgEng1', 'view-imgEng2', 'view-diagramImg'];
            const phIds = ['logoPlaceholder', 'ph-imgDesc1', 'ph-imgDesc2', 'ph-imgEng1', 'ph-imgEng2', 'ph-diagramImg'];
            const inpIds = ['logoInput', 'imgDesc1', 'imgDesc2', 'imgEng1', 'imgEng2', 'diagramImg'];
            
            imgIds.forEach((id, idx) => removeImage(id, phIds[idx], inpIds[idx]));

            // Reset Tabela
            const tbody = document.querySelector('#actionTable tbody');
            tbody.innerHTML = '';
            addActionRow(); addActionRow(); addActionRow();

            // Reset Dimensões
            ['sec2-text', 'sec3-text', 'sec2-imgs', 'sec3-imgs', 'solutionText', 'participantsText', 'logoBox'].forEach(id => {
                const el = document.getElementById(id);
                if(el) { el.style.width = ''; el.style.height = ''; }
            });

            showToast("Formulário limpo.", 'success');
        }

        function removeImage(imgId, placeholderId, inputId) {
            const img = document.getElementById(imgId);
            const ph = document.getElementById(placeholderId);
            const inp = document.getElementById(inputId);
            const actions = document.getElementById('actions-' + imgId);
            const parent = ph.parentElement;

            img.src = "";
            img.classList.add('hidden');
            ph.classList.remove('hidden');
            if (actions) actions.classList.add('hidden');
            if (inp) inp.value = "";

            if(!parent.classList.contains('logo-upload-box')) {
                parent.classList.remove('border-solid');
                parent.classList.add('border-dashed');
            }
        }

        function updateLayout(sec, type) {
            const c = document.getElementById(`${sec}-container`);
            const t = document.getElementById(`${sec}-text`);
            const imgs = document.getElementById(`${sec}-imgs`);
            const img2 = imgs.children[1];

            // Reset styles
            t.style.height = ''; t.style.width = '';
            imgs.style.height = ''; imgs.style.width = '';
            
            c.className = "h-44 border border-transparent hover:border-gray-200 transition-colors rounded p-0.5";
            t.className = "input-bare text-sm static-input";
            imgs.className = "gap-2 overflow-hidden min-h-0";
            
            img2.classList.remove('hidden', 'layout-hidden');
            imgs.classList.remove('hidden', 'layout-hidden');

            if (type === 'default') {
                c.classList.add('flex', 'flex-col', 'gap-2');
                t.classList.add('w-full', 'h-16', 'resizable-y');
                imgs.classList.add('flex-grow', 'grid', 'grid-cols-2');
            } else if (type === 'side') {
                c.classList.add('flex', 'flex-row', 'gap-2');
                t.classList.add('flex-1', 'h-full', 'resize-none');
                imgs.classList.add('w-1/3', 'h-full', 'resizable-x', 'grid', 'grid-cols-1');
                img2.classList.add('hidden', 'layout-hidden');
            } else if (type === 'text') {
                c.classList.add('block');
                t.classList.add('w-full', 'h-full', 'resize-none');
                imgs.classList.add('hidden', 'layout-hidden');
            }
        }

        function dateMask(i) {
            let v = i.value.replace(/\D/g, '');
            if (v.length > 8) v = v.slice(0, 8);
            if (v.length > 4) i.value = `${v.slice(0, 2)}/${v.slice(2, 4)}/${v.slice(4)}`;
            else if (v.length > 2) i.value = `${v.slice(0, 2)}/${v.slice(2)}`;
            else i.value = v;
        }

        function triggerUpload(id) { document.getElementById(id).click(); }

        function previewImage(input, imgId, phId) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = e => displayImage(e.target.result, imgId, phId);
                reader.readAsDataURL(input.files[0]);
            }
        }

        function displayImage(base64, imgId, phId) {
            const img = document.getElementById(imgId);
            const ph = document.getElementById(phId);
            const actions = document.getElementById('actions-' + imgId);
            const parent = ph.parentElement;

            img.src = base64;
            img.classList.remove('hidden');
            if(ph) ph.classList.add('hidden');
            if(actions) actions.classList.remove('hidden');

            if(!parent.classList.contains('logo-upload-box')) {
                parent.classList.add('border-solid');
                parent.classList.remove('border-dashed');
            }
        }

        function setupDragAndDrop(boxId, inputId) {
            const box = document.getElementById(boxId);
            const input = document.getElementById(inputId);
            
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eName => {
                box.addEventListener(eName, e => { e.preventDefault(); e.stopPropagation(); }, false);
            });
            
            ['dragenter', 'dragover'].forEach(eName => {
                box.addEventListener(eName, () => box.classList.add('drag-over'), false);
            });
            ['dragleave', 'drop'].forEach(eName => {
                box.addEventListener(eName, () => box.classList.remove('drag-over'), false);
            });

            box.addEventListener('drop', e => {
                const dt = e.dataTransfer;
                if (dt.files.length > 0) {
                    input.files = dt.files;
                    input.dispatchEvent(new Event('change'));
                }
            });
        }

        function addActionRow(data = null) {
            const tbody = document.querySelector('#actionTable tbody');
            const row = tbody.insertRow();
            row.className = "border-b hover:bg-gray-50 align-top";
            
            const act = data ? data.action : '';
            const resp = data ? data.resp : '';
            const date = data ? data.date : '';
            const stat = data ? data.status : 'aberto';

            row.innerHTML = `
                <td class="border-r p-1">
                    <textarea class="input-bare border-none focus:ring-0 bg-transparent w-full text-xs resize-none overflow-hidden" 
                              rows="1" placeholder="Ação..." oninput="autoResizeRow(this)">${act}</textarea>
                </td>
                <td class="border-r align-middle"><input type="text" value="${resp}" class="input-bare border-none focus:ring-0 bg-transparent w-full text-xs" placeholder="Resp."></td>
                <td class="border-r align-middle"><input type="text" value="${date}" class="input-bare border-none focus:ring-0 bg-transparent w-full text-xs" placeholder="dd/mm/yyyy" maxlength="10" oninput="dateMask(this)"></td>
                <td class="text-center align-middle">
                    <select class="bg-transparent text-[10px] font-bold text-center w-full focus:outline-none" onchange="updateStatusColor(this)">
                        <option value="aberto" ${stat === 'aberto' ? 'selected' : ''}>Aberto</option>
                        <option value="andamento" ${stat === 'andamento' ? 'selected' : ''}>Andamento</option>
                        <option value="concluido" ${stat === 'concluido' ? 'selected' : ''}>Concluído</option>
                    </select>
                </td>
                <td class="text-center align-middle no-print"><button onclick="removeRow(this)" class="text-red-400"><i class="fas fa-times"></i></button></td>
            `;
            updateStatusColor(row.querySelector('select'));
            if(act) autoResizeRow(row.querySelector('textarea'));
        }

        function autoResizeRow(t) { t.style.height = 'auto'; t.style.height = t.scrollHeight + 'px'; }
        function removeRow(btn) { btn.closest('tr').remove(); }
        function toggleAnalysis(v) {
            document.getElementById('view-ishikawa').classList.toggle('hidden', v !== 'ishikawa');
            document.getElementById('view-5whys').classList.toggle('hidden', v !== '5whys');
        }
    </script>
</body>
</html>
